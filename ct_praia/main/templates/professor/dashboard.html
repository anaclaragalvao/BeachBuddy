{% extends "base.html" %}
{% block title %}Dashboard do Professor{% endblock %}
{% block body_class %}dashboard-page{% endblock %}
{% block content %}
<section class="prof-dashboard">
  <header class="dashboard-header">
    <div>
      <h1 class="dashboard-title">Olá, professor!</h1>
      <p class="dashboard-subtitle">Acompanhe seus próximos treinos e organize sua agenda com facilidade.</p>
    </div>
    <div class="dashboard-actions">
  <button type="button" class="btn" id="open-create-treino" data-open-create>Novo treino</button>
    </div>
  </header>

  <section class="dashboard-stats" aria-label="Resumo dos treinos">
    <article class="stat-card">
      <span class="stat-label">Treinos encontrados</span>
      <strong class="stat-value">{{ total_treinos }}</strong>
      {% if total_treinos == 0 %}
      <span class="stat-footnote">Sem treinos agendados</span>
      {% endif %}
    </article>
    <article class="stat-card">
      <span class="stat-label">Alunos próximo treino</span>
      {% if next_treino %}
      <strong class="stat-value">{{ next_treino_alunos }}</strong>
      {% else %}
      <strong class="stat-value">—</strong>
      <span class="stat-footnote">Cadastre um novo treino</span>
      {% endif %}
    </article>
    <article class="stat-card">
      <span class="stat-label">Próximo treino</span>
      {% if next_treino %}
      <strong class="stat-value">{{ next_treino.data|date:"d/m" }} às {{ next_treino.hora_inicio|time:"H:i" }}</strong>
      <span class="stat-footnote">{{ next_treino.modalidade }} · {{ next_treino.ct.nome }}</span>
      {% else %}
      <strong class="stat-value">—</strong>
      <span class="stat-footnote">Cadastre um novo treino</span>
      {% endif %}
    </article>
  </section>

  <form method="get" class="dashboard-filters" aria-label="Filtros de treinos">
    <div class="filter-field">
      <label for="filter-date">Data</label>
      <input type="date" id="filter-date" name="data" value="{{ selected_date }}">
    </div>
    <div class="filter-field">
      <label for="filter-ct">Centro de treinamento</label>
      <select id="filter-ct" name="ct">
        <option value="">Todos</option>
        {% for ct in cts %}
        <option value="{{ ct.id }}" {% if selected_ct == ct.id %}selected{% endif %}>{{ ct.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-sm">Filtrar</button>
      <a href="{% url 'prof_dashboard' %}" class="btn btn-outline btn-sm">Limpar</a>
    </div>
  </form>

  {% if treinos %}
  <section class="treino-grid" aria-live="polite">
    {% for t in treinos %}
    <article class="treino-card">
      <header class="treino-card__header">
        <h2>{{ t.modalidade }}</h2>
        <span class="treino-card__date">{{ t.data|date:"d \d\e F" }} · {{ t.hora_inicio|time:"H:i" }} - {{ t.hora_fim|time:"H:i" }}</span>
      </header>
      <dl class="treino-card__details">
        <div>
          <dt>Centro</dt>
          <dd>{{ t.ct.nome }}</dd>
        </div>
        <div>
          <dt>Nível</dt>
          <dd>{{ t.nivel }}</dd>
        </div>
        <div>
          <dt>Vagas</dt>
          <dd>{{ t.vagas_disponiveis }}/{{ t.vagas }}</dd>
        </div>
        <div>
          <dt>Data e hora</dt>
          <dd>{{ t.data|date:"d/m/Y" }} · {{ t.hora_inicio|time:"H:i" }} - {{ t.hora_fim|time:"H:i" }}</dd>
        </div>
      </dl>
      {% if t.observacoes %}
      <p class="treino-card__notes">{{ t.observacoes }}</p>
      {% endif %}
      <footer class="treino-card__footer">
        <div class="treino-card__actions">
          <button type="button"
                  class="btn btn-sm"
                  data-open-edit
                  data-treino-id="{{ t.pk }}"
                  data-ct-id="{{ t.ct_id }}"
                  data-modalidade="{{ t.modalidade|escape }}"
                  data-data="{{ t.data|date:'Y-m-d' }}"
                  data-hora-inicio="{{ t.hora_inicio|time:'H:i' }}"
                  data-hora-fim="{{ t.hora_fim|time:'H:i' }}"
                  data-vagas="{{ t.vagas }}"
                  data-nivel="{{ t.nivel|escape }}"
                  data-observacoes="{{ t.observacoes|default:''|escape }}">
            Editar
          </button>
          <button type="button"
                  class="btn btn-outline btn-sm btn-danger-link"
                  data-open-delete
                  data-delete-id="{{ t.pk }}"
                  data-delete-modalidade="{{ t.modalidade|escape }}"
                  data-delete-ct="{{ t.ct.nome|escape }}"
                  data-delete-date="{{ t.data|date:'d/m/Y' }}"
                  data-delete-time="{{ t.hora_inicio|time:'H:i' }} - {{ t.hora_fim|time:'H:i' }}"
                  aria-label="Excluir treino {{ t.modalidade }}">
            Excluir treino
          </button>
        </div>
      </footer>
    </article>
    {% endfor %}
  </section>
  {% else %}
  <div class="empty-state">
    <h2>Você ainda não possui treinos cadastrados.</h2>
    <p>Crie seu primeiro treino para montar a agenda dos alunos.</p>
  <button type="button" class="btn" data-open-create>Cadastrar treino</button>
  </div>
  {% endif %}

  <section class="dashboard-support" aria-label="Suporte e dicas">
    <h2>Dicas rápidas</h2>
    <ul>
      <li>Use filtros para separar treinos por CT ou data específica.</li>
      <li>Mantenha as vagas alinhadas com a capacidade real da turma.</li>
      <li>Adicione observações para avisos importantes aos alunos.</li>
    </ul>
    <p class="support-contact">Precisa de ajuda? Envie um e-mail para <a href="mailto:contato@beachbuddy.com.br">contato@beachbuddy.com.br</a>.</p>
  </section>
</section>

{% with current_mode=modal_mode|default:"create" %}
<div class="modal-backdrop{% if show_treino_modal %} is-open{% endif %}"
     id="treino-modal"
     data-initial-mode="{{ current_mode }}"
     data-editing-id="{{ editing_treino_id|default:'' }}"
     data-has-errors="{% if treino_form.errors %}1{% else %}0{% endif %}"
     aria-hidden="{% if show_treino_modal %}false{% else %}true{% endif %}"
     role="dialog"
     aria-labelledby="treino-modal-title">
  <div class="modal-card">
    <header class="modal-card__header">
      <h2 id="treino-modal-title">{% if current_mode == 'edit' %}Editar treino{% else %}Novo treino{% endif %}</h2>
      <button type="button" class="modal-close" data-close-modal aria-label="Fechar formulário">&times;</button>
    </header>
    <form method="post" class="modal-form" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="{% if current_mode == 'edit' %}update_treino{% else %}create_treino{% endif %}">
      <input type="hidden" name="treino_id" value="{{ editing_treino_id|default:'' }}">
      {% if treino_form.non_field_errors %}
      <div class="form-errors">
        {% for error in treino_form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
      <div class="modal-form__grid">
        {% for field in treino_form %}
        <div class="modal-field{% if field.errors %} has-error{% endif %}">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
          <small>{{ field.help_text }}</small>
          {% endif %}
          {% if field.errors %}
          <span class="error-text">{{ field.errors|join:", " }}</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn" data-submit-label>{% if current_mode == 'edit' %}Salvar alterações{% else %}Cadastrar{% endif %}</button>
        <button type="button" class="btn btn-outline" data-close-modal>Cancelar</button>
      </div>
    </form>
  </div>
</div>
{% endwith %}

<div class="modal-backdrop" id="delete-treino-modal" aria-hidden="true" role="dialog" aria-labelledby="delete-treino-modal-title">
  <div class="modal-card modal-card--narrow">
    <header class="modal-card__header">
      <h2 id="delete-treino-modal-title">Confirmar exclusão</h2>
      <button type="button" class="modal-close" data-close-delete aria-label="Fechar confirmação">&times;</button>
    </header>
    <form method="post" class="modal-delete-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete_treino">
      <input type="hidden" name="treino_id" value="">
      <div class="modal-body">
        <p>Tem certeza de que deseja excluir o treino <strong data-delete-modalidade></strong>?</p>
        <p><span data-delete-summary></span></p>
        <p class="modal-warning">Essa ação não poderá ser desfeita.</p>
      </div>
      <div class="modal-actions">
  <button type="submit" class="btn btn-red">Excluir</button>
        <button type="button" class="btn btn-outline" data-close-delete>Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('treino-modal');
    if (!modal) { return; }
    const deleteModal = document.getElementById('delete-treino-modal');
    const createButtons = document.querySelectorAll('[data-open-create]');
    const closeButtons = modal.querySelectorAll('[data-close-modal]');
    const firstField = modal.querySelector('input, select, textarea');
    const form = modal.querySelector('form');
    const hiddenAction = form.querySelector('input[name="action"]');
    const hiddenTreinoId = form.querySelector('input[name="treino_id"]');
    const title = modal.querySelector('#treino-modal-title');
    const submitBtn = form.querySelector('[data-submit-label]');

    const fieldRefs = {
      ct: form.querySelector('[name="ct"]'),
      modalidade: form.querySelector('[name="modalidade"]'),
      data: form.querySelector('[name="data"]'),
      hora_inicio: form.querySelector('[name="hora_inicio"]'),
      hora_fim: form.querySelector('[name="hora_fim"]'),
      vagas: form.querySelector('[name="vagas"]'),
      nivel: form.querySelector('[name="nivel"]'),
      observacoes: form.querySelector('[name="observacoes"]'),
    };

    function setMode(mode, data = null) {
      if (mode === 'edit') {
        hiddenAction.value = 'update_treino';
        submitBtn.textContent = 'Salvar alterações';
        title.textContent = 'Editar treino';
      } else {
        hiddenAction.value = 'create_treino';
        submitBtn.textContent = 'Cadastrar';
        title.textContent = 'Novo treino';
      }

      if (mode === 'edit' && data) {
        hiddenTreinoId.value = data.id || '';
        if (fieldRefs.ct) fieldRefs.ct.value = data.ct || '';
        if (fieldRefs.modalidade) fieldRefs.modalidade.value = data.modalidade || '';
        if (fieldRefs.data) fieldRefs.data.value = data.data || '';
        if (fieldRefs.hora_inicio) fieldRefs.hora_inicio.value = data.hora_inicio || '';
        if (fieldRefs.hora_fim) fieldRefs.hora_fim.value = data.hora_fim || '';
        if (fieldRefs.vagas) fieldRefs.vagas.value = data.vagas || '';
        if (fieldRefs.nivel) fieldRefs.nivel.value = data.nivel || '';
        if (fieldRefs.observacoes) fieldRefs.observacoes.value = data.observacoes || '';
      }

      if (mode === 'create') {
        hiddenTreinoId.value = '';
        if (data === null) {
          // limpa apenas se nenhum dado fornecido (evita sobrescrever erros do servidor)
          Object.values(fieldRefs).forEach(field => {
            if (!field) { return; }
            if (field.tagName === 'SELECT') {
              field.selectedIndex = 0;
            } else {
              field.value = '';
            }
          });
        }
      }
      modal.dataset.currentMode = mode;
    }

    function openModal() {
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      if (firstField) {
        setTimeout(() => firstField.focus(), 50);
      }
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
    }

    createButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        setMode('create');
        openModal();
      });
    });

    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') { return; }
      if (modal.classList.contains('is-open')) {
        closeModal();
      }
      if (deleteModal && deleteModal.classList.contains('is-open')) {
        hideDeleteModal();
      }
    });

    const editButtons = document.querySelectorAll('[data-open-edit]');
    editButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const data = {
          id: btn.dataset.treinoId,
          ct: btn.dataset.ctId,
          modalidade: btn.dataset.modalidade,
          data: btn.dataset.data,
          hora_inicio: btn.dataset.horaInicio,
          hora_fim: btn.dataset.horaFim,
          vagas: btn.dataset.vagas,
          nivel: btn.dataset.nivel,
          observacoes: btn.dataset.observacoes,
        };
        setMode('edit', data);
        openModal();
      });
    });

    if (modal.classList.contains('is-open')) {
      const initialMode = modal.dataset.initialMode || 'create';
      const hasErrors = modal.dataset.hasErrors === '1';
      const editingId = modal.dataset.editingId;
      if (initialMode === 'edit') {
        const editBtn = document.querySelector(`[data-open-edit][data-treino-id="${editingId}"]`);
        let data = null;
        if (editBtn) {
          data = {
            id: editBtn.dataset.treinoId,
            ct: editBtn.dataset.ctId,
            modalidade: editBtn.dataset.modalidade,
            data: editBtn.dataset.data,
            hora_inicio: editBtn.dataset.horaInicio,
            hora_fim: editBtn.dataset.horaFim,
            vagas: editBtn.dataset.vagas,
            nivel: editBtn.dataset.nivel,
            observacoes: editBtn.dataset.observacoes,
          };
        }
        setMode('edit', hasErrors ? null : data);
      } else {
        setMode('create', hasErrors ? null : {});
      }
      openModal();
    }

    function showDeleteModal(data) {
      if (!deleteModal) { return; }
      const summaryEl = deleteModal.querySelector('[data-delete-summary]');
      const modalidadeEl = deleteModal.querySelector('[data-delete-modalidade]');
      const formDelete = deleteModal.querySelector('form');
      const treinoIdInput = formDelete.querySelector('input[name="treino_id"]');
      if (modalidadeEl) {
        modalidadeEl.textContent = data.modalidade || '';
      }
      if (summaryEl) {
        const parts = [];
        if (data.ct) { parts.push(data.ct); }
        if (data.date) { parts.push(data.date); }
        if (data.time) { parts.push(data.time); }
        summaryEl.textContent = parts.filter(Boolean).join(' · ');
      }
      treinoIdInput.value = data.id || '';
      deleteModal.classList.add('is-open');
      deleteModal.setAttribute('aria-hidden', 'false');
      const primaryBtn = formDelete.querySelector('.btn-danger');
      if (primaryBtn) {
        setTimeout(() => primaryBtn.focus(), 50);
      }
    }

    function hideDeleteModal() {
      if (!deleteModal) { return; }
      deleteModal.classList.remove('is-open');
      deleteModal.setAttribute('aria-hidden', 'true');
    }

    if (deleteModal) {
      const deleteButtons = document.querySelectorAll('[data-open-delete]');
      const dismissButtons = deleteModal.querySelectorAll('[data-close-delete]');

      deleteButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const data = {
            id: btn.dataset.deleteId,
            modalidade: btn.dataset.deleteModalidade,
            ct: btn.dataset.deleteCt,
            date: btn.dataset.deleteDate,
            time: btn.dataset.deleteTime,
          };
          showDeleteModal(data);
        });
      });

      deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
          hideDeleteModal();
        }
      });

      dismissButtons.forEach(btn => btn.addEventListener('click', hideDeleteModal));
    }
  })();
</script>
{% endblock %}