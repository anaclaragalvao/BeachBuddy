{% extends "base.html" %}
{% block title %}Dashboard do Professor{% endblock %}
{% block body_class %}dashboard-page{% endblock %}
{% block content %}
<section class="prof-dashboard">
  <header class="dashboard-header">
    <div>
      <h1 class="dashboard-title">Olá, professor!</h1>
      <p class="dashboard-subtitle">Acompanhe seus próximos treinos e organize sua agenda com facilidade.</p>
    </div>
    <div class="dashboard-actions">
      <button type="button" class="btn" id="open-create-treino">Novo treino</button>
    </div>
  </header>

  <section class="dashboard-stats" aria-label="Resumo dos treinos">
    <article class="stat-card">
      <span class="stat-label">Treinos encontrados</span>
      <strong class="stat-value">{{ total_treinos }}</strong>
      {% if total_treinos == 0 %}
      <span class="stat-footnote">Sem treinos agendados</span>
      {% endif %}
    </article>
    <article class="stat-card">
      <span class="stat-label">Alunos próximo treino</span>
      {% if next_treino %}
      <strong class="stat-value">{{ next_treino_alunos }}</strong>
      {% else %}
      <strong class="stat-value">—</strong>
      <span class="stat-footnote">Cadastre um novo treino</span>
      {% endif %}
    </article>
    <article class="stat-card">
      <span class="stat-label">Próximo treino</span>
      {% if next_treino %}
      <strong class="stat-value">{{ next_treino.data|date:"d/m" }} às {{ next_treino.hora_inicio|time:"H:i" }}</strong>
      <span class="stat-footnote">{{ next_treino.modalidade }} · {{ next_treino.ct.nome }}</span>
      {% else %}
      <strong class="stat-value">—</strong>
      <span class="stat-footnote">Cadastre um novo treino</span>
      {% endif %}
    </article>
  </section>

  <form method="get" class="dashboard-filters" aria-label="Filtros de treinos">
    <div class="filter-field">
      <label for="filter-date">Data</label>
      <input type="date" id="filter-date" name="data" value="{{ selected_date }}">
    </div>
    <div class="filter-field">
      <label for="filter-ct">Centro de treinamento</label>
      <select id="filter-ct" name="ct">
        <option value="">Todos</option>
        {% for ct in cts %}
        <option value="{{ ct.id }}" {% if selected_ct == ct.id %}selected{% endif %}>{{ ct.nome }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="btn btn-sm">Filtrar</button>
      <a href="{% url 'prof_dashboard' %}" class="btn btn-outline btn-sm">Limpar</a>
    </div>
  </form>

  {% if treinos %}
  <section class="treino-grid" aria-live="polite">
    {% for t in treinos %}
    <article class="treino-card">
      <header class="treino-card__header">
        <h2>{{ t.modalidade }}</h2>
        <span class="treino-card__date">{{ t.data|date:"d \d\e F" }} · {{ t.hora_inicio|time:"H:i" }} - {{ t.hora_fim|time:"H:i" }}</span>
      </header>
      <dl class="treino-card__details">
        <div>
          <dt>Centro</dt>
          <dd>{{ t.ct.nome }}</dd>
        </div>
        <div>
          <dt>Nível</dt>
          <dd>{{ t.nivel }}</dd>
        </div>
        <div>
          <dt>Vagas</dt>
          <dd>{{ t.vagas_disponiveis }}/{{ t.vagas }}</dd>
        </div>
        <div>
          <dt>Data e hora</dt>
          <dd>{{ t.data|date:"d/m/Y" }} · {{ t.hora_inicio|time:"H:i" }} - {{ t.hora_fim|time:"H:i" }}</dd>
        </div>
      </dl>
      {% if t.observacoes %}
      <p class="treino-card__notes">{{ t.observacoes }}</p>
      {% endif %}
      <footer class="treino-card__footer">
        <a href="{% url 'treino_update' t.pk %}" class="btn btn-sm">Editar</a>
        <a href="{% url 'treino_detail' t.pk %}" class="btn btn-outline btn-sm">Detalhes</a>
      </footer>
    </article>
    {% endfor %}
  </section>
  {% else %}
  <div class="empty-state">
    <h2>Você ainda não possui treinos cadastrados.</h2>
    <p>Crie seu primeiro treino para montar a agenda dos alunos.</p>
    <a href="{% url 'treino_create' %}" class="btn">Cadastrar treino</a>
  </div>
  {% endif %}

  <section class="dashboard-support" aria-label="Suporte e dicas">
    <h2>Dicas rápidas</h2>
    <ul>
      <li>Use filtros para separar treinos por CT ou data específica.</li>
      <li>Mantenha as vagas alinhadas com a capacidade real da turma.</li>
      <li>Adicione observações para avisos importantes aos alunos.</li>
    </ul>
    <p class="support-contact">Precisa de ajuda? Envie um e-mail para <a href="mailto:contato@beachbuddy.com.br">contato@beachbuddy.com.br</a>.</p>
  </section>
</section>

<div class="modal-backdrop{% if show_create_modal %} is-open{% endif %}" id="create-treino-modal" aria-hidden="{% if show_create_modal %}false{% else %}true{% endif %}" role="dialog" aria-labelledby="create-treino-title">
  <div class="modal-card">
    <header class="modal-card__header">
      <h2 id="create-treino-title">Novo treino</h2>
      <button type="button" class="modal-close" data-close-modal aria-label="Fechar formulário">&times;</button>
    </header>
    <form method="post" class="modal-form" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="create_treino">
      {% if treino_form.non_field_errors %}
      <div class="form-errors">
        {% for error in treino_form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
      <div class="modal-form__grid">
        {% for field in treino_form %}
        <div class="modal-field{% if field.errors %} has-error{% endif %}">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
          <small>{{ field.help_text }}</small>
          {% endif %}
          {% if field.errors %}
          <span class="error-text">{{ field.errors|join:", " }}</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn">Cadastrar</button>
        <button type="button" class="btn btn-outline" data-close-modal>Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const modal = document.getElementById('create-treino-modal');
    if (!modal) { return; }
    const openBtn = document.getElementById('open-create-treino');
    const closeButtons = modal.querySelectorAll('[data-close-modal]');
    const firstField = modal.querySelector('input, select, textarea');

    function openModal() {
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      if (firstField) {
        setTimeout(() => firstField.focus(), 50);
      }
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
    }

    if (openBtn) {
      openBtn.addEventListener('click', openModal);
    }

    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));

    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && modal.classList.contains('is-open')) {
        closeModal();
      }
    });

    if (modal.classList.contains('is-open')) {
      openModal();
    }
  })();
</script>
{% endblock %}